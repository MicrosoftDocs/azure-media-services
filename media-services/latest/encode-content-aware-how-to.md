---
title: How to use the content-aware encoding preset
description: This article discusses how to use the content-aware encoding preset in Microsoft Azure Media Services v3.
services: media-services
documentationcenter: ''
author: jiayali-ms
manager: femila
editor: ''
ms.service: media-services
ms.workload: 
ms.devlang: csharp
ms.topic: how-to
ms.date: 09/17/2021
ms.author: inhenkel
ms.custom: devx-track-csharp
---

# How to use the content-aware encoding preset

[!INCLUDE [media services api v3 logo](./includes/v3-hr.md)]

## Introduction
The [content-aware encoding presets](encode-content-aware-concept.md) better prepare content for delivery by [adaptive bitrate streaming](encode-autogen-bitrate-ladder.md), where videos need to encode at multiple bitrates.It includes custom logic that lets the encoder render the optimal bitrate value for a given resolution without requiring extensive computational analysis. The preset determines the optimal number of layers, appropriate bitrate and resolution settings for delivery by adaptive streaming.

Compared to the adaptive streaming preset, content-aware encoding is more effective for low and medium complexity videos, where the output files will be at a lower bitrate but still at a quality that delivers a good viewing experience.

### Using the content-aware encoding presets

To encode with the content-aware preset in your code, use the [BuiltInStandardEncoderPreset](/dotnet/api/microsoft.azure.management.media.models.builtinstandardencoderpreset) object and set the [PresetName](/dotnet/api/microsoft.azure.management.media.models.builtinstandardencoderpreset.presetname) property to one of the following built-in preset names.

- **ContentAwareEncoding**  - this preset supports H.264.
- **H265ContentAwareEncoding** - this preset supports HEVC (H.265)

> [!NOTE]
> Make sure to use the **ContentAwareEncoding** preset not  ContentAwareEncodingExperimental. Or, if you would like to encode with HEVC, you can use **H265ContentAwareEncoding**.

```csharp
TransformOutput[] output = new TransformOutput[]
{
   new TransformOutput
   {
      // The preset for the Transform is set to one of Media Services built-in sample presets.
      // You can customize the encoding settings by changing this to use "StandardEncoderPreset" class.
      Preset = new BuiltInStandardEncoderPreset()
      {
         // This sample uses the new preset for content-aware encoding
         PresetName = EncoderNamedPreset.ContentAwareEncoding
      }
   }
};
```

## Configure output settings

In addition, developers can also control the range of outputs that the content-aware encoding preset uses when deciding the optimal settings for encoding the adaptive bitrate streaming ladder.

By using the **PresetConfigurations** class, developers can pass in a set of constraints and options to the content-aware encoding preset to control the resulting files generated by the encoder. The properties are especially useful for situations where you want to limit all encoding to a specific maximum resolution to control the experience or costs of your encoding jobs.  It is also useful to be able to control the maximum and minimum bitrates that your audience may be able to support on a mobile network or in a global region that has bandwidth constraints.

The PresetConfigurations class allows you to adjust the following settings on the content-aware encoding presets. 


| Property                   | Description                                                                                                                                                                         |
| ------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| complexity              | Speed, Balanced, or Quality. Allows you to configure the encoder settings to control the balance between speed and quality. Example: set Complexity as Speed for faster encoding but less compression efficiency |
| interleaveOutput          |    Controls how the output MP4 file is formatted.  They can be interleaved with both audio and video to make them easier to share individually, or they can be separated audio and video files to make it easier to late-bind extra language audio tracks or modify the audio later.                                                                                                                                                                                 |
| keyFrameIntervalInSeconds |        Sets the key-frame distance used for each group of pictures (GOP) when encoding the files.  Typical modern adaptive streaming protocols use 2 seconds.  Depending on what network conditions you are delivering over, it can sometimes help to use longer intervals. Check with your CDN provider or do some experimentation on your own networks.                                                                                                                                                                             |
| maxBitrateBps             |               Constrains the top bitrate of the adaptive streaming ladder.  This constraint is useful for controlling storage costs and network delivery costs.  In addition, this can also keep your delivered bitrates within a range that is supported by your clients.                                                                                                                                                                       |
| maxHeight                 |       The top resolution that is allowed to be encoded in the adaptive ladder.  This is useful for also controlling costs, or controlling the experience of your audience. You can limit all encodes to be Standard Definition, or limit them to be max 720P if desired.                                                                                                                                                                              |
| maxLayers                 |        This property controls the number of layers in the adaptive streaming ladder. This also by definition controls the number of files output as MP4 into the storage container.  Lowering this value reduces costs as well, since you are producing fewer output renditions, the total number of encoding minutes will be reduced. use this in combination with maxHeight and maxBitrateBps to keep costs in control during encoding and make your billing more predictable.                                                                                                                                                                             |
| minBitrateBps             |                           This controls the lowest bitrate that the encoder will choose.  Use this to optimize for quality on your low bitrate and low-resolution renditions.                                                                                                                                                         |
| minHeight                 |     This setting controls the smallest resolution that the adaptive bitrate ladder will produce. This helps to avoid clients selecting a very low-resolution rendition that could be too blurry for the type of content that you are encoding. This helps a lot with the quality of experience you are delivering.                                                                                                                                                                                |
|

### Example code for configuring content-aware preset

The following code snippet is from the sample [Encode with content-aware, H.246, and constraints](https://github.com/Azure-Samples/media-services-v3-dotnet/tree/main/VideoEncoding/Encoding_H264_ContentAware_Constrained).

[!code-csharp[Main](../../../media-services-v3-dotnet/VideoEncoding/Encoding_H264_ContentAware_Constrained/Program.cs#PresetConfigurations)]

## Samples

The following samples demonstrate the various codecs and constraints that can be used, how to instantiate the preset, and how to submit and monitor an encoding job.

### .NET

| Sample | Description|
|---------|------------------|
| [Encode with content-aware and H.246](https://github.com/Azure-Samples/media-services-v3-dotnet/tree/main/VideoEncoding/Encoding_H264_ContentAware) | Demonstrates the most basic use of H.264 content-aware encoding without any constraints |
| [Encode with content-aware, H.246, and constraints](https://github.com/Azure-Samples/media-services-v3-dotnet/tree/main/VideoEncoding/Encoding_H264_ContentAware_Constrained) | Demonstrates how to use the PresetConfigurations class to constrain the output behavior of the preset|
| [Encode with content-aware and HEVC (H.265)](https://github.com/Azure-Samples/media-services-v3-dotnet/tree/main/VideoEncoding/Encoding_HEVC_ContentAware) | Shows basic usage of the HEVC codec with content-aware encoding and no constraints.  The PresetConfigurations class is also supported for HEVC and can be added to this sample|

> [!NOTE]
> Encoding jobs using the `ContentAwareEncoding` preset are being billed based on solely the output minutes. AMS uses two-pass encoding and there are not any additional charges associated with using any of the presets beyond what is listed on our [pricing page](https://azure.microsoft.com/pricing/details/media-services/#overview).
  
## Next steps

* [Tutorial: Upload, encode, and stream videos with Media Services v3](stream-files-tutorial-with-api.md)
* [Tutorial: Encode a remote file based on URL and stream the video - REST](stream-files-tutorial-with-rest.md)
* [Tutorial: Encode a remote file based on URL and stream the video - CLI](stream-files-cli-quickstart.md)
* [Tutorial: Encode a remote file based on URL and stream the video - .NET](stream-files-dotnet-quickstart.md)
* [Tutorial: Encode a remote file based on URL and stream the video - Node.js](stream-files-nodejs-quickstart.md)
